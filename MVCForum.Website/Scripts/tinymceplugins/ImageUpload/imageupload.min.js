tinymce.PluginManager.add("forumimageinsert", function (a) { a.addButton("forumimageinsert", { icon: "media", tooltip: buttonTitle, onclick: function () { a.windowManager.open({ title: buttonTitle + "（小屏幕设备请拖动此标题栏）", url: app_base + "file/imageuploadtinymce/", width: 450, height: 170, buttons: [{ text: buttonOk, classes: "widget btn btn-default first abs-layout-item", onclick: function () { var h, i, j, k, l, b = a.windowManager.getWindows()[0], c = b.getContentWindow().document.getElementById("content"), d = b.getContentWindow().document.getElementById("desc"), e = b.getContentWindow().document.getElementById("external"), f = b.getContentWindow().document.getElementById("externalrow"); if (b.getContentWindow().document.getElementById("uploadrow"), h = b.getContentWindow().document.getElementById("waiting"), "" != e.value) { if (!e.value.startsWith("http")) return alert(enterValidUrl), !1; i = d.value, j = e.value, k = '<img class="img-responsive" src="' + j + '?width=690" alt="' + i + '" />', a.insertContent(k), b.close() } else { if ("" == c.value) return alert(selectFile), !1; if (c.files[0].size > 512e4) return alert(maxImageFileSize), !1; if ("image/jpeg" != c.files[0].type && "image/jpg" != c.files[0].type && "image/png" != c.files[0].type && "image/gif" != c.files[0].type) return alert(onlyImages), !1; h.style.display = "block", l = new FormData, l.append("file", c.files[0]), $.ajax({ url: app_base + "api/TinyMce/UploadImage", data: l, processData: !1, contentType: !1, async: !0, type: "POST" }).done(function (c) { var e, g, i; "" != c ? (e = d.value, g = c, i = '<img class="img-responsive" src="' + g + '?width=690&upscale=false" alt="' + e + '" />', a.insertContent(i), b.close()) : (alert(generalError), h.style.display = "none", f.style.display = "block") }).fail(function (a, b) { alert("Request failed: " + a.responseText + " --- " + b), h.style.display = "none", f.style.display = "block" }) } } }, { text: buttonClose, onclick: "close" }] }) } }) });